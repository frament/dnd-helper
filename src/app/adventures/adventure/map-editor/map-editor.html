<div class="bg-gray-800 rounded-lg p-6 h-full flex flex-col">
  <!-- Заголовок и кнопки действий -->
  <div class="flex justify-between items-center mb-6">
    <h3 class="text-xl font-bold text-white">Редактор карты</h3>
    <div class="flex space-x-2">
      <button pButton icon="pi pi-save"
              label="Сохранить"
              class="p-button-success"
              (click)="saveMap()"></button>
      <button pButton icon="pi pi-trash"
              label="Удалить"
              class="p-button-danger"
              (click)="deleteMap()"></button>
      <button pButton icon="pi pi-download"
              label="Экспорт"
              class="p-button-info"
              (click)="exportMap()"></button>
    </div>
  </div>

  <!-- Редактор названия -->
  <div class="mb-6">
    <label class="block text-gray-400 mb-2">Название карты</label>
    <input pInputText [(ngModel)]="map().title"
           class="w-full text-xl font-bold"
           placeholder="Введите название карты...">
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Левая колонка: Основная информация -->
    <div class="lg:col-span-1">
      <div class="bg-gray-900 p-5 rounded-xl mb-6">
        <h4 class="text-lg font-semibold text-white mb-4">Основные параметры</h4>

        <!-- Тип карты -->
        <div class="mb-4">
          <label class="block text-gray-400 mb-2">Тип карты</label>
          <p-select [options]="mapTypes"
                      [(ngModel)]="map().type"
                      placeholder="Выберите тип карты"
                      class="w-full"></p-select>
        </div>

        <!-- Масштаб -->
        <div class="mb-4">
          <label class="block text-gray-400 mb-2">Масштаб (1:)</label>
          <p-inputNumber [(ngModel)]="map().scale"
                         [showButtons]="true"
                         buttonLayout="horizontal"
                         incrementButtonIcon="pi pi-plus"
                         decrementButtonIcon="pi pi-minus"
                         [min]="100"
                         [max]="10000"
                         class="w-full"></p-inputNumber>
        </div>

        <!-- Размеры -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-gray-400 mb-2">Ширина (м)</label>
            <p-inputNumber [(ngModel)]="map().width"
                           [showButtons]="true"
                           [min]="10"
                           [max]="10000"
                           class="w-full"></p-inputNumber>
          </div>
          <div>
            <label class="block text-gray-400 mb-2">Высота (м)</label>
            <p-inputNumber [(ngModel)]="map().height"
                           [showButtons]="true"
                           [min]="10"
                           [max]="10000"
                           class="w-full"></p-inputNumber>
          </div>
        </div>

        <!-- Теги -->
        <div class="mb-4">
          <label class="block text-gray-400 mb-2">Теги карты</label>
          <p-autoComplete [(ngModel)]="map().tags"
                          multiple fluid
                   placeholder="Добавьте теги..."
                   class="w-full"></p-autoComplete>
        </div>

        <!-- Описание -->
        <div>
          <label class="block text-gray-400 mb-2">Описание</label>
          <textarea pInputTextarea [(ngModel)]="map().description"
                    [rows]="3"
                    class="w-full"
                    placeholder="Добавьте описание карты..."></textarea>
        </div>
      </div>

      <!-- Слои карты -->
      <div class="bg-gray-900 p-5 rounded-xl">
        <h4 class="text-lg font-semibold text-white mb-4">Управление слоями</h4>

        <p-listbox [options]="layers"
                   [(ngModel)]="selectedLayer"
                   optionLabel="name"
                   [style]="{'width': '100%', 'height': '200px'}">
          <ng-template let-item pTemplate="item">
            <div class="flex items-center">
              <i [class]="'pi mr-3 ' + item.icon"></i>
              <span>{{item.name}}</span>
              <p-toggleswitch [ngModel]="item.visible" (ngModelChange)="item.visible = $event"
                             class="ml-auto"></p-toggleswitch>
            </div>
          </ng-template>
        </p-listbox>

        <div class="flex space-x-2 mt-3">
          <button pButton icon="pi pi-plus"
                  label="Добавить слой"
                  class="p-button-text p-button-sm"></button>
          <button pButton icon="pi pi-trash"
                  label="Удалить"
                  class="p-button-text p-button-sm p-button-danger"
                  [disabled]="!selectedLayer"></button>
        </div>
      </div>
    </div>

    <!-- Центральная колонка: Изображение карты -->
    <div class="lg:col-span-2">
      <div class="bg-gray-900 p-5 rounded-xl h-full flex flex-col">
        <h4 class="text-lg font-semibold text-white mb-4">Изображение карты</h4>

        <!-- Область загрузки и предпросмотра -->
        <div class="flex-1 flex flex-col items-center justify-center relative border-2 border-dashed border-gray-600 rounded-xl"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event)"
             (click)="fileInput.click()">

          <!-- Предпросмотр карты -->
          @if (map().imageUrl) {
            <img [src]="map().imageUrl"
                 alt="Карта"
                 class="max-h-[500px] max-w-full object-contain">
          } @else {
            <div class="text-center p-8">
              <i class="pi pi-cloud-upload text-5xl text-gray-500 mb-4"></i>
              <p class="text-xl text-gray-400">Перетащите изображение сюда</p>
              <p class="text-gray-500 mt-2">или нажмите для выбора файла</p>
              <p class="text-sm text-gray-500 mt-4">Поддерживаемые форматы: JPG, PNG, WebP<br>Максимальный размер: 10MB</p>
            </div>
          }

          <!-- Индикатор загрузки -->
          @if (uploading) {
            <div class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center">
              <p-progressSpinner strokeWidth="4"
                                 animationDuration=".5s"></p-progressSpinner>
              <span class="ml-4 text-gray-300">Загрузка... {{uploadProgress}}%</span>
            </div>
          }

          <!-- Скрытый input для загрузки файлов -->
          <input #fileInput type="file" accept="image/*"
                 class="hidden"
                 (change)="onFileSelected($event)">
        </div>

        <!-- Кнопки управления изображением -->
        <div class="flex flex-wrap justify-center gap-3 mt-6">
          <!-- Загрузка изображения -->
          <button pButton
                  icon="pi pi-upload"
                  label="Загрузить"
                  class="p-button-success"
                  (click)="fileInput.click()"></button>

          <!-- Выбрать из библиотеки -->
          <button pButton
                  icon="pi pi-images"
                  label="Библиотека"
                  class="p-button-secondary"
                  (click)="openImageLibrary()"></button>

          <!-- Удалить изображение -->
          @if (map().imageUrl) {
            <button pButton
                    icon="pi pi-trash"
                    label="Удалить"
                    class="p-button-danger"
                    (click)="removeImage()"></button>
          }
        </div>

        <!-- Инструменты редактирования -->
        <div class="mt-6">
          <h5 class="text-gray-400 mb-3">Инструменты</h5>
          <div class="flex flex-wrap gap-2">
            <button pButton icon="pi pi-pencil"
                    class="p-button-outlined p-button-help"
                    [pTooltip]="'Рисование'"></button>
            <button pButton icon="pi pi-tag"
                    class="p-button-outlined p-button-help"
                    [pTooltip]="'Добавить метку'"></button>
            <button pButton icon="pi pi-ruler"
                    class="p-button-outlined p-button-help"
                    [pTooltip]="'Измерить расстояние'"></button>
            <button pButton icon="pi pi-search-plus"
                    class="p-button-outlined p-button-help"
                    [pTooltip]="'Увеличить'"></button>
            <button pButton icon="pi pi-search-minus"
                    class="p-button-outlined p-button-help"
                    [pTooltip]="'Уменьшить'"></button>
            <button pButton icon="pi pi-lock"
                    class="p-button-outlined p-button-help"
                    [pTooltip]="'Заблокировать перемещение'"></button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
